# グミ物理エンジン要件定義書

## 概要

現在の Canvas ベースのカスタム物理エンジンを Matter.js に移行するための要件抽出

---

## 1. 物理シミュレーション要件

### 1.1 重力・速度・加速度

- **重力**: 0.45 の垂直下向き加速度を常に適用
- **空気抵抗**: 毎フレーム速度に 0.995 を乗算（指数関数的減衰）
- **移動**: 各フレームで速度をポジションに加算

### 1.2 衝突・反発

- **反発係数（restitution）**: 0.8（現在）
  - グミ同士の衝突時に適用
  - 床との衝突時にも適用
  - 低速時の静止判定あり（vy < 0.25 で静止）
- **衝撃力計算**: 標準的なインパルスベース物理
  - 相対速度の法線方向成分を計算
  - 質量比を考慮した逆質量（inverse mass）を使用
  - 両方のボディに対称的に力を適用

### 1.3 摩擦

- **接線摩擦係数**: 0.01（非常に小さい = 滑りやすい）
- 衝突時の接線方向速度に適用
- 制限范囲内で適用：`-frictionTangent <= jt <= frictionTangent`

---

## 2. 境界条件・制約

### 2.1 画面境界（壁）

- **左壁**: x = 0、反発係数 0.8 で反射
- **右壁**: x = W（キャンバス幅）、反発係数 0.8 で反射
- **床**: y = H - 10（キャンバス高さ - 10）、反発係数 0.8 で反射
- 壁との衝突後も速度が保持される（一部減衰）

### 2.2 中心バイアス（オプション）

- **inwardForce**: 0.0（デフォルト）
- 指定時は画面中央に向かう力を適用：`p.vx += (cx - p.x) * inwardForce`
- 両方向に作用（水平のみ）

### 2.3 粒子寿命

- **maxParticles**: 1000
- 超過時は古い粒子から削除

---

## 3. 粒子プロパティ

### 3.1 必須属性

| 属性   | 型     | 説明                              |
| ------ | ------ | --------------------------------- |
| x, y   | number | ワールド座標                      |
| vx, vy | number | 速度ベクトル                      |
| r      | number | 半径（衝突判定用）                |
| m      | number | 質量（weight から計算、最小値 1） |
| color  | string | HEX カラーコード                  |

### 3.2 オプション属性

| 属性            | 型      | 説明                                                          |
| --------------- | ------- | ------------------------------------------------------------- |
| isBirthday      | boolean | 誕生日フラグ（UI 用）                                         |
| title           | string  | イベントタイトル                                              |
| date            | string  | イベント日付                                                  |
| shape           | string  | 形状（'circle' \| 'square' \| 'pencil' \| 'heart' \| 'star'） |
| angle           | number  | 回転角度（特に pencil 用）                                    |
| angularVelocity | number  | 角速度（特に pencil 用）                                      |

### 3.3 グミサイズ計算

```
baseRadius = Math.max(6, 5 + weight * 3)
  // weight 0.9~4 → radius 8.7~17

if (isBirthday):
  effectiveRadius = theoreticalMaxRadius * 1.5  // 25.5

if (shape === 'star'):
  collisionRadius = effectiveRadius * 0.85  // 衝突判定を小さめに
```

### 3.4 初期速度

- 生成時位置: x = 画面中央 + 正規分布（σ = W \* centerBias）
- 生成時位置: y = -(Math.random() \* 200 + 20)（画面上部）
- 初期速度: vx = (Math.random() - 0.5) \* 0.25、vy = 0

---

## 4. 形状・衝突判定

### 4.1 支援形状

1. **circle**: 単純な円
2. **square**: 正方形（s = r \* 1.6）
3. **star**: 5 角スター（外接円 r \* 1.8）
4. **heart**: ハート型（ベジェ曲線）
5. **pencil**: 鉛筆型（回転矩形）

### 4.2 AABB 衝突判定

- 各形状の境界ボックスを計算
- 回転を含む（特に pencil）
- 衝突判定は AABB → 厳密判定（円同士）の順

### 4.3 衝突解決

- **ペアの検出**: グリッドベース空間分割（セルサイズ 24）
  - 近傍セルを走査（9 セル）
  - 重複チェック防止（i < j）
- **衝突応答**: 位置補正 + インパルス計算
  - 重なりの 50% ずつ押し出し
  - 両ボディの質量比に応じた力配分

---

## 5. 鉛筆の回転物理（ペンシル固有）

### 5.1 角速度更新

```
torqueMagnitude = 0.02
angularVelocity += Math.sin(angle) * torqueMagnitude
angularVelocity *= 0.98  // 空気抵抗
angle += angularVelocity
```

### 5.2 床衝突時

- 角速度を -0.6 で乗算（反転・減衰）
- バウンド時に回転を増幅

### 5.3 描画時

- Canvas 行列変換で回転を適用
- 角度パラメータ（angle）を使用

---

## 6. インタラクション

### 6.1 ドラッグ

- **検出**: クリック位置から逆順で最初の粒子を探す
- **処理**:
  1. ドラッグ粒子の速度を 0 にリセット
  2. 毎フレーム、マウス位置に追従
  3. ドラッグ速度を計算（前フレームとの差分）
  4. 近くの他の粒子を弾き飛ばす
     - 衝突チェック
     - 法線方向に力を付与（impactForce = 2.5）

### 6.2 マウスイベント

- mousedown: 粒子選択 + ドラッグ開始
- mousemove: 位置更新 + 近傍粒子の反発
- mouseup / mouseleave: ドラッグ終了

### 6.3 その他インタラクション

- **shake()**: 全粒子にランダムな速度を追加（地震効果）
  - vx += (Math.random() - 0.5) \* 30
  - vy += (Math.random() - 0.7) \* 25

---

## 7. 描画・可視化

### 7.1 キャンバスレンダリング

- バックグラウンド: `#eee` 色
- 床: キャンバス下部 10px
- 各粒子を形状に応じて描画

### 7.2 ビジュアルエフェクト

- **ハイライト**: 各形状に白色ハイライト（rgba(255,255,255,0.35)）
- **誕生日マーク**: 白色 SVG アイコンをオーバーレイ
- **ツールチップ**: ドラッグ時に日付・タイトルを吹き出しで表示

---

## 8. パフォーマンス要件

### 8.1 フレームレート

- requestAnimationFrame ベース（60 FPS 想定）

### 8.2 粒子数

- **最大**: 1000 粒子
- **推奨**: 300~500 粒子（滑らか）

### 8.3 計算最適化

- **グリッド分割**: 24px セルサイズ
- **インクリメンタル衝突検出**: ペア検出のみ実施
- **描画**: 全粒子を毎フレーム再描画（キャンバスクリア使用）

---

## 9. 設定パラメータ

| パラメータ      | デフォルト | 説明                          |
| --------------- | ---------- | ----------------------------- |
| gravity         | 0.45       | 重力加速度                    |
| air             | 0.995      | 空気抵抗（速度減衰）          |
| restitution     | 0.8        | 反発係数                      |
| frictionTangent | 0.01       | 接線摩擦                      |
| centerBias      | 0.12       | 初期生成時の中心バイアス（σ） |
| inwardForce     | 0.0        | 中心引力（0 = 無効）          |
| maxParticles    | 1000       | 最大粒子数                    |
| cellSize        | 24         | グリッド分割セルサイズ        |

---

## 10. Matter.js への移行方針

### 10.1 エンジン化

現在の `GummyWorld` の責務を Matter.js に委譲:

- 物理シミュレーション → Matter.Engine
- 衝突検出 → Matter.Events（衝突コールバック）
- 剛体管理 → Matter.Body / Matter.Bodies
- 制約・ジョイント → Matter.Constraint（将来拡張用）

### 10.2 保持すべき独自実装

- 形状描画（circle, square, pencil, heart, star）
- ドラッグインタラクション（マウスイベント処理）
- ツールチップ UI
- グリッド描画（床）

### 10.3 イベント体系

- 衝突コールバック（collisionStart / collisionEnd）
- マウスイベント（mousedown / mousemove / mouseup）
- Canvas requestAnimationFrame ループ

---

## 11. 検証チェックリスト

- [ ] グミが重力に従って落ちる
- [ ] グミ同士が衝突して反発する
- [ ] グミが床で跳ね返る
- [ ] グミが壁で反射する
- [ ] 鉛筆がランダムに回転する
- [ ] ドラッグで粒子を動かせる
- [ ] ドラッグ中に周辺粒子が弾き飛ばされる
- [ ] shake() で全粒子が揺れる
- [ ] 1000 粒子で 60 FPS 維持
- [ ] 形状別の見分けが可能
- [ ] 誕生日マークが表示される
- [ ] ツールチップが表示される
- [ ] キャンバスリサイズに対応

---

## 12. リスク・注意点

### 12.1 既知の複雑性

1. **鉛筆の回転**: トルク・角速度・衝突時の相互作用
2. **多形状衝突**: AABB → 厳密判定の 2 段階実装
3. **ドラッグ時の粒子反発**: 力の計算が複雑

### 12.2 Matter.js との差異対応

- Matter.js の単位系（ピクセルベース）確認
- デフォルトパラメータ（重力 = 0.001）の調整
- 衝突イベントの精度確認

### 12.3 テスト戦略

- ユニットテスト: 物理計算の検証
- ビジュアルテスト: 挙動の目視確認
- パフォーマンステスト: フレームレート計測

---

## 終了条件

移行が完了したと判定する条件:

1. Matter.js エンジンが正常に動作
2. 全要件の検証チェックがすべて ✓
3. パフォーマンス（≥ 60 FPS）を確保
4. 既存の UI/UX が損なわれていない
