<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>カレンダーのデータ取得（グミ用）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Google Identity Services: OAuth 2.0 トークン クライアント -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
      }
      button {
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
      }
      #output {
        background: #f4f4f8;
        padding: 1rem;
        overflow: auto;
        max-height: 600px;
        border-radius: 4px;
      }
      .month-section {
        margin-bottom: 1.5rem;
      }
      details {
        background: white;
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
      }
      summary {
        cursor: pointer;
        font-weight: bold;
        color: #2563eb;
        padding: 0.5rem;
        user-select: none;
      }
      summary:hover {
        background: #f0f9ff;
        border-radius: 4px;
      }
      .event-list {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0 0 0;
      }
      .event-item {
        padding: 0.5rem;
        border-bottom: 1px solid #e0e0e0;
        font-family: monospace;
      }
      .event-item:last-child {
        border-bottom: none;
      }
      .event-date {
        color: #2563eb;
        font-weight: bold;
        margin-right: 1rem;
      }
      .event-title {
        color: #1f2937;
      }
    </style>
  </head>
  <body>
    <h1>カレンダーのデータを取得する</h1>
    <p>
      年を選択してボタンを押すと、その年の Google Calendar
      イベントを取得します（読み取り専用）。
    </p>

    <div style="margin-bottom: 1rem">
      <label for="year-select">年を選択: </label>
      <select id="year-select" style="padding: 0.5rem; font-size: 1rem">
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
        <option value="2026">2026</option>
      </select>
    </div>

    <button id="fetch-btn">カレンダーのデータを取得する</button>
    <p id="status"></p>
    <div id="output"></div>

    <script type="module">
      // ★★ ここを書き換える ★★
      const CLIENT_ID = import.meta.env.VITE_GOOGLE_CLIENT_ID; // Cloud Consoleで発行されたクライアントID
      const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

      // 今年の範囲をISO文字列（UTC）で作成
      function getYearRangeUTC(year = new Date().getFullYear()) {
        const timeMin = new Date(Date.UTC(year, 0, 1, 0, 0, 0)).toISOString();
        const timeMax = new Date(
          Date.UTC(year, 11, 31, 23, 59, 59)
        ).toISOString();
        return { timeMin, timeMax, year };
      }

      // 状態表示用
      const $status = document.getElementById("status");
      const $output = document.getElementById("output");
      const $btn = document.getElementById("fetch-btn");
      const $yearSelect = document.getElementById("year-select");

      let tokenClient = null;
      let accessToken = null;
      let pendingTokenRequest = null;

      function setStatus(msg) {
        $status.textContent = msg;
      }

      function groupByMonth(events) {
        const map = new Map(); // key: 'YYYY-MM', value: array of events
        for (const ev of events) {
          const startRaw = ev.start?.dateTime || ev.start?.date;
          if (!startRaw) continue;
          const isoDate = startRaw.split("T")[0]; // YYYY-MM-DD
          const ym = isoDate.slice(0, 7); // YYYY-MM
          if (!map.has(ym)) map.set(ym, []);
          map.get(ym).push(ev);
        }
        return map;
      }

      function displayEvents(events) {
        if (events.length === 0) {
          $output.innerHTML =
            '<p style="color: #6b7280;">イベントがありません</p>';
          return;
        }

        const monthly = groupByMonth(events);
        const months = Array.from(monthly.keys()).sort();

        const html = months
          .map((ym) => {
            const monthEvents = monthly.get(ym);
            const count = monthEvents.length;

            const eventItems = monthEvents
              .map((ev) => {
                const startRaw = ev.start?.dateTime || ev.start?.date || "";
                const dateStr = startRaw.split("T")[0] || "日付不明";
                const title = ev.summary || "(タイトルなし)";

                return `<li class="event-item">
                <span class="event-date">${dateStr}</span> | <span class="event-title">${title}</span>
              </li>`;
              })
              .join("");

            return `<section class="month-section">
            <details open>
              <summary>${ym} | ${count}件</summary>
              <ul class="event-list">
                ${eventItems}
              </ul>
            </details>
          </section>`;
          })
          .join("");

        $output.innerHTML = html;
      }

      function initTokenClient() {
        if (tokenClient) return;
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error) {
              setStatus("認証エラー: " + resp.error);
              console.error(resp);
              if (pendingTokenRequest) {
                pendingTokenRequest.reject(new Error(resp.error));
                pendingTokenRequest = null;
              }
            } else {
              accessToken = resp.access_token;
              if (pendingTokenRequest) {
                pendingTokenRequest.resolve(resp.access_token);
                pendingTokenRequest = null;
              }
            }
          },
        });
      }

      async function ensureAccessToken() {
        if (accessToken) return accessToken;

        // Initialize token client if needed
        if (!tokenClient) {
          initTokenClient();
        }

        // Create promise to wait for callback
        return new Promise((resolve, reject) => {
          pendingTokenRequest = { resolve, reject };

          // Check if already has token
          if (accessToken) {
            tokenClient.requestAccessToken({ prompt: "" });
          } else {
            tokenClient.requestAccessToken({ prompt: "consent" });
          }

          // Timeout after 60 seconds
          setTimeout(() => {
            if (pendingTokenRequest) {
              pendingTokenRequest.reject(
                new Error("認証がタイムアウトしました")
              );
              pendingTokenRequest = null;
            }
          }, 60000);
        });
      }

      async function fetchEventsForYear(year) {
        const { timeMin, timeMax } = getYearRangeUTC(year);
        const token = await ensureAccessToken();

        const params = new URLSearchParams({
          timeMin,
          timeMax,
          singleEvents: "true",
          orderBy: "startTime",
          maxResults: "2500", // 年間最大件数の目安
        });

        const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?${params.toString()}`;
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Calendar API エラー (${res.status}): ${errText}`);
        }
        const data = await res.json();
        return data.items ?? [];
      }

      $btn.addEventListener("click", async () => {
        setStatus("認証しています…");
        try {
          await ensureAccessToken();
          setStatus("データ取得中…");
          const year = parseInt($yearSelect.value); // 選択された年を取得
          const events = await fetchEventsForYear(year);
          setStatus(`取得完了：${events.length}件（${year}年）`);
          displayEvents(events);
        } catch (e) {
          console.error(e);
          setStatus("失敗：" + e.message);
        }
      });
    </script>
  </body>
</html>
