# Matter.js パラメータ調整テストガイド

## 現在のパラメータ設定

```typescript
private cfg = {
  gravity: 0.0015,        // Matter.js 標準単位（重力加速度）
  air: 0.001,            // 未使用（frictionAir で制御）
  restitution: 0.9,      // 反発係数（0.8 → 0.9）
  friction: 0.005,       // Body の friction
  frictionAir: 0.001,    // Body の frictionAir（空気抵抗）
  centerBias: 0.12,      // 初期生成時の中心バイアス
  inwardForce: 0.0,      // 中心引力（無効）
  maxParticles: 1000,    // 最大粒子数
};
```

## テスト項目

### 1. 重力テスト

**目的**: グミが適切な速度で落下しているか確認

**テスト方法**:

1. http://localhost:5176 にアクセス
2. 「グミにする」ボタンでイベント取得
3. Canvas にグミが表示される
4. グミが自然な速度で落下することを確認

**期待値**:

- グミが 1-2 秒で Canvas 下部に到達
- 落下速度が徐々に加速する

**調整パラメータ**:

```typescript
// 重力を増やす（落下を速く）
gravity: 0.002; // 0.0015 から増加

// 重力を減らす（落下を遅く）
gravity: 0.001; // 0.0015 から減少
```

---

### 2. 反発テスト

**目的**: グミが床で跳ね返るか、反発係数が適切か確認

**テスト方法**:

1. グミが床に到達するのを待つ
2. グミの跳ね返り高さと回数を観察
3. 複数回の跳ね返り後、静止することを確認

**期待値**:

- 最初の跳ね返り：床から 20-30% の高さ
- 2 回目以降：徐々に低くなる
- 5-10 回後に静止

**調整パラメータ**:

```typescript
// 反発を強くする（より高く跳ねる）
restitution: 1.0; // 0.9 から増加

// 反発を弱くする（すぐに止まる）
restitution: 0.7; // 0.9 から減少
```

---

### 3. 空気抵抗テスト

**目的**: グミが自然な速度減衰をするか確認

**テスト方法**:

1. グミをドラッグして高速で移動させる
2. 放した後、グミが減速して停止する様子を観察

**期待値**:

- 1-2 秒で速度が大幅に低下
- 自然な減衰（急激でない）

**調整パラメータ**:

```typescript
// 空気抵抗を強くする（早く止まる）
frictionAir: 0.002; // 0.001 から増加

// 空気抵抗を弱くする（長く滑る）
frictionAir: 0.0005; // 0.001 から減少
```

---

### 4. 摩擦テスト

**目的**: グミが床で滑らかに止まるか確認

**テスト方法**:

1. グミが床で複数回跳ね返った後の動き
2. 最後の停止状態での滑りを観察

**期待値**:

- 最終的に静止（跳ね返りが止まる）
- 水平方向の滑りが少ない

**調整パラメータ**:

```typescript
// 摩擦を強くする（滑りを減らす）
friction: 0.01; // 0.005 から増加

// 摩擦を弱くする（滑りやすく）
friction: 0.002; // 0.005 から減少
```

---

### 5. 衝突テスト

**目的**: グミ同士が正しく衝突・反発するか確認

**テスト方法**:

1. 複数のグミを生成
2. 落下中のグミ同士の衝突を観察
3. 衝突後、分散して落ちることを確認

**期待値**:

- グミが互いに貫通しない
- 衝突後に方向が変わる
- 複数グミが積み重なる

**現在の設定**:

- Matter.js が自動的に衝突を処理

---

### 6. ドラッグテスト

**目的**: マウスドラッグでグミを自由に操作できるか確認

**テスト方法**:

1. Canvas上でグミにマウスカーソルを乗せる
2. カーソルが「grab」に変わることを確認
3. ドラッグしてグミを移動
4. 放すとグミが落下することを確認

**期待値**:

- 滑らかなドラッグ操作
- ドラッグ中は物理演算が停止（Constraint で管理）
- 放した後は通常の物理演算に戻る

**調整パラメータ**:

```typescript
// Constraint の stiffness を調整
// GummyWorld.ts の handleMouseDown メソッド内
Constraint.create({
  // ...
  stiffness: 1, // 1.0 = 完全に拘束、0.5 = より柔軟
});
```

---

### 7. shake() テスト

**目的**: shake 機能が全グミに正しく作用しているか確認

**テスト方法**:

1. グミを複数生成
2. 「ゆらす」ボタンをクリック
3. すべてのグミが動くことを確認

**期待値**:

- すべてのグミが上方向と水平方向に揺れる
- 揺れの幅が大きい
- 落下速度が一時的に上がる

**現在の設定**:

```typescript
shake() {
  for (const body of this.bodies) {
    const randomVx = (Math.random() - 0.5) * 30;
    const randomVy = (Math.random() - 0.7) * 25;
    Body.setVelocity(body, {
      x: body.velocity.x + randomVx,
      y: body.velocity.y + randomVy,
    });
  }
}
```

---

## パフォーマンステスト

### 粒子数による影響

**テスト方法**:

1. 「グミにする」ボタンで全月分を生成（最大 1000 粒子）
2. ブラウザの開発者ツール（F12 → Performance）でフレームレートを監視

**期待値**:

- 300-500 粒子: 60 FPS 確保
- 1000 粒子: 30-60 FPS （やや低下）

**最適化**:

- enableSleeping を有効化（静止したグミを自動スリープ）

---

## トラブルシューティング

### グミが床を貫通する

**原因**: 重力が強すぎるか、床の衝突判定が不正
**解決**:

1. 重力を減らす: `gravity: 0.0012`
2. 床の位置を確認: `this.H - 5` が正しいか

### グミが跳ね返らない

**原因**: restitution が低い
**解決**: `restitution: 0.9` に増やす

### ドラッグがカクカク

**原因**: Constraint の stiffness が低い
**解決**: `stiffness: 1.0` に変更

### パフォーマンス低下

**原因**: 粒子数が多すぎる
**解決**: `maxParticles: 500` に減らす

---

## 推奨テスト順序

1. ビルド成功確認
2. 重力テスト
3. 反発テスト
4. 空気抵抗テスト
5. 衝突テスト
6. ドラッグテスト
7. shake() テスト
8. パフォーマンステスト

---

## 最終チェックリスト

- [ ] グミが重力で落下する
- [ ] グミが床で跳ね返る
- [ ] グミ同士が衝突して反発する
- [ ] ドラッグで操作可能
- [ ] shake() で全グミが揺れる
- [ ] 300+ 粒子で 60 FPS
- [ ] 形状別（circle, square, pencil, star, heart）で異なる見た目
- [ ] 誕生日マークが表示される
- [ ] イベントがフィルター可能
